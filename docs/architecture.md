# 架构设计文档

## 1. 引言

本文档介绍了 Foo 解释器的架构设计。Foo 是一个受 Forth 语言启发的简单解释器，采用面向堆栈的设计，使用后缀表达式（逆波兰表达式）进行书写。其高扩展性允许用户通过 C 语言定义函数并供 Foo 使用。

## 2. 整体架构

Foo 解释器的整体架构包括以下几个核心组件：

- **虚拟机状态管理**：管理解释器的运行状态，包括字典、堆栈等。
- **字典管理**：存储和管理用户定义的单词、函数、变量等。
- **堆栈操作**：实现数据堆栈和循环堆栈的操作。
- **解析与执行**：解析输入的 Foo 代码并执行相应的操作。

## 3. 核心组件详细设计

### 3.1 虚拟机状态管理

`F_State` 结构体是解释器的核心，它维护了解释器的运行状态，包括字典、堆栈、输入流等信息。以下是其主要字段：

- `dict`：指向字典的指针，存储用户定义的单词、函数、变量等。
- `data`：数据堆栈，用于存储操作数。
- `loop`：循环堆栈，用于支持循环语句。
- `input`：输入流，用于读取脚本或用户输入。
- `line_count`：当前行号，用于错误报告。
- `running`：指示解释器是否正在运行。
- `interactive`：指示解释器是否处于交互模式。

### 3.2 字典管理

字典用于存储和管理用户定义的单词、函数、变量等。`F_Dict` 结构体包含以下字段：

- `entry`：字典条目数组，每个条目包含单词名称、类型及相应数据。
- `vars`：变量值数组，存储变量的值。
- `var_size`：当前变量的数量。
- `size`：当前字典条目的数量。

字典支持以下操作：

- `F_createDict`：创建一个新的字典。
- `F_destroyDict`：销毁一个字典并释放相关资源。
- `F_find`：在字典中查找指定的单词。
- `F_addExpr`：向字典中添加一个新的表达式。
- `F_addFunc`：向字典中添加一个新的原始函数。
- `F_addControl`：向字典中添加一个新的控制结构。
- `F_addVar`：向字典中添加一个新的变量。

### 3.3 堆栈操作

堆栈是解释器的核心数据结构之一，用于存储操作数和控制流信息。`F_Stack` 结构体包含以下字段：

- `stack`：存储堆栈元素的数组。
- `capacity`：堆栈的容量。
- `size`：堆栈中当前元素的数量。

堆栈支持以下操作：

- `F_createStack`：创建一个新的堆栈。
- `F_destroyStack`：销毁一个堆栈并释放相关资源。
- `F_pushValue`：向堆栈中压入一个值。
- `F_popValue`：从堆栈中弹出一个值。
- `F_topValue`：获取堆栈顶部的值。

数据堆栈和循环堆栈分别用于存储操作数和循环控制信息。

### 3.4 解析与执行

解释器的解析与执行模块负责解析输入的 Foo 代码并执行相应的操作。主要函数包括：

- `F_eval`：评估并执行输入的 Foo 代码。
- `F_parseNum`：解析数字并压入数据堆栈。
- `F_parseChar`：解析字符并压入数据堆栈。
- `F_parseWord`：解析单词并执行相应的操作。
- `F_compile`：编译用户定义的函数。
- `F_read`：从输入流中读取一行代码。
- `F_write`：将值输出到控制台。

控制结构（如 `if`、`else`、`then`、`begin`、`until`）通过相应的控制函数进行处理。

## 4. 初始化与执行流程

### 4.1 初始化

解释器的初始化过程包括以下步骤：

1. 创建虚拟机状态。
2. 初始化字典，添加内置的函数、控制结构和变量。
3. 设置输入流，进入交互模式或脚本模式。

### 4.2 执行流程

解释器的执行流程如下：

1. 从输入流中读取一行代码。
2. 解析并执行该行代码。
3. 重复上述步骤，直到输入流结束或用户退出。

在执行过程中，解释器会根据输入的代码类型（数字、字符、单词等）调用相应的解析和执行函数。

其中，最核心的机制是函数调用，当遇到自定义的函数时，解释器会从对应的表达式开始独立执行，若解析的函数表达式中调用了其他函数或者自身，解释器又会以新函数的表达式为入口进行解析，从而能够实现函数的递归调用等功能。

需要注意的是，由于代码按行读取，函数定义请在单行内完成。

## 5. 扩展性设计

Foo 解释器具有良好的扩展性，允许通过 C 语言定义函数并供 Foo 使用。可以通过以下方式扩展解释器的功能：

- 定义新的原始函数并添加到字典。
- 定义新的控制结构并添加到字典。
- 定义新的变量并进行操作。